# film 管线

在 pbrt 中，film 类会对传感设备进行建模。当确定了每一条 Camera Ray 的 Radiance 时，Film 类决定了，在 film 上的点附近的 piexl 上，采集到的样本的贡献度。当主循环推出时，Film 写入一个文件中。

对于 realistic  真实相机模型，章节 6.4.7 介绍了一种计算方法，用于计算一个相机的传感器，在一定时间内到达的能量，我们可以认为，这个传感器这一定时间内，一小块区域内，测出的是平均辐射强度。```Camera::GenerateRayDifferential```该函数返回了具体选择怎样的测量方式，以及射线的权重。因此，film 的实现只需要通过这些提供的辐射值，并乘上权重即可。

本节介绍了单个 Film 的实现，该实现，使用像素重构方程，来计算最终的像素值。对于一个基于物理的渲染器，它将图片用一个浮点图像的格式进行存储。这么做的原因是，用浮点数进行存储会更加灵活。避免图像量化到 8bit 时，丢失精度。

为了在显示设备上显示此类图像，我们需要把这些浮点像素值，映射为离散的值来显示。例如，显示器通常是使用 RGB 来描述颜色，而不是任意光谱的功率分布。因此用通用基函数系数描述的光谱，必须转化成 RGB 形势，然后才能显示。还有一个问题是，显示器可以显示的辐射范围，比真实场景中光的范围要小得多。所以像素值必须映射到一个可以显示的范围，来得到理想的显示方式

## Film 类

Film 类在 ```core/film.h``` 和 ```core/film.cpp``` 中被定义

![1](07_29/1.png)

![2](07_29/2.png)

Film 的构造函数

![3](07_29/3.png)

Crop Window 是一个在 NDC 空间上表示的渲染范围，他的大小范围是 ```(0,0)~(1,1)```，我们只会允许在 Crop 范围内的执行存储和写入。这对于后续调试是非常有帮助的。

![4](07_29/4.png)

![5](07_29/5.png)

![6](07_29/6.png)

为每个像素分配动态内存

这里对于光谱的内容，我们使用的是 XYZ 的形势去存储，原因有下
- 不需要使用完整的光谱表达，只需要存储 XYZ 三条人眼最敏感的值即可
- 相对于 RGB，使用 XYZ 的表达，是和显示无关的，RGB 则需要一组特定的显示响应曲线。当然，在最后都会转为 RGB 存在文件中。

对于典型的滤波器设置，每一个图像样本，可以会对 16个或者以上 的像素造成影响。这里会花费很长的时间。

因此，Film 做了一个预计算。

![7](07_29/7.png)

![8](07_29/8.png)

![9](07_29/9.png)

实际的采样范围，会比我们的图像范围要大

![10](07_29/10.png)

实际的 film 幕布大小，其核心计算依赖于

![11](07_29/11.png)















